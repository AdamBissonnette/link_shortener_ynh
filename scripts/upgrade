#!/bin/bash

source /usr/share/yunohost/helpers

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="$app" --action="stop"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading source files..."
ynh_setup_source --dest_dir="$install_dir" --keep=".env data/"

#=================================================
# UPGRADE NODE.JS DEPENDENCIES AND REBUILD
#=================================================
ynh_script_progression "Upgrading Node.js dependencies..."

pushd "$install_dir"
    # Install all dependencies (including devDependencies for TypeScript build)
    ynh_hide_warnings ynh_exec_as_app npm install
    
    # Rebuild TypeScript to JavaScript
    ynh_script_progression "Rebuilding TypeScript application..."
    ynh_hide_warnings ynh_exec_as_app npm run build
    
    # Remove devDependencies after build to save space
    ynh_hide_warnings ynh_exec_as_app npm prune --production
popd

#=================================================
# UPDATE A CONFIGURATION
#=================================================
ynh_script_progression "Updating configuration..."

# The .env file is preserved during upgrade
# You may want to update it with new settings if needed
# but preserve existing values

# Ensure data directory exists
mkdir -p "$install_dir/data"

chmod -R o-rwx "$install_dir"
chown -R "$app:www-data" "$install_dir"

#=================================================
# INITIALIZE CONFIG SETTINGS IF NOT SET
#=================================================
# Read current values from .env and store in settings if not already set
if [ -z "${admin_password:-}" ]; then
    admin_password=$(grep "^ADMIN_PASSWORD=" "$install_dir/.env" | cut -d'=' -f2-)
    ynh_app_setting_set --app="$app" --key=admin_password --value="$admin_password"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=allowed_admin_ips)" ]; then
    allowed_admin_ips=$(grep "^ALLOWED_ADMIN_IPS=" "$install_dir/.env" | cut -d'=' -f2- || echo "*")
    ynh_app_setting_set --app="$app" --key=allowed_admin_ips --value="$allowed_admin_ips"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=admin_path)" ]; then
    admin_path_value=$(grep "^ADMIN_PATH=" "$install_dir/.env" | cut -d'=' -f2- || echo "/derp")
    ynh_app_setting_set --app="$app" --key=admin_path --value="$admin_path_value"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=root_redirect)" ]; then
    root_redirect_value=$(grep "^ROOT_REDIRECT=" "$install_dir/.env" | cut -d'=' -f2- || echo "https://example.com")
    ynh_app_setting_set --app="$app" --key=root_redirect --value="$root_redirect_value"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=not_found_redirect)" ]; then
    not_found_redirect_value=$(grep "^NOT_FOUND_REDIRECT=" "$install_dir/.env" | cut -d'=' -f2- || echo "https://example.com")
    ynh_app_setting_set --app="$app" --key=not_found_redirect --value="$not_found_redirect_value"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=session_window_min)" ]; then
    session_window=$(grep "^SESSION_WINDOW_MIN=" "$install_dir/.env" | cut -d'=' -f2- || echo "30")
    ynh_app_setting_set --app="$app" --key=session_window_min --value="$session_window"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=user_cookie_max_days)" ]; then
    cookie_days=$(grep "^USER_COOKIE_MAX_DAYS=" "$install_dir/.env" | cut -d'=' -f2- || echo "730")
    ynh_app_setting_set --app="$app" --key=user_cookie_max_days --value="$cookie_days"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=cookie_secure)" ]; then
    ynh_app_setting_set --app="$app" --key=cookie_secure --value="1"
fi

if [ -z "$(ynh_app_setting_get --app="$app" --key=rate_limit_window)" ]; then
    rate_limit=$(grep "^RATE_LIMIT_WINDOW=" "$install_dir/.env" | cut -d'=' -f2- || echo "60")
    ynh_app_setting_set --app="$app" --key=rate_limit_window --value="$rate_limit"
fi

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

ynh_config_add_nginx

ynh_config_add_systemd

yunohost service add "$app" --description="Link Shortener Service"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service="$app" --action="start"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
